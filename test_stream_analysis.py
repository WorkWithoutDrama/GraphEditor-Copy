#!/usr/bin/env python3
"""
–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –¢–ó
"""

import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ –ø—É—Ç—å
sys.path.append('.')

# –°–æ–∑–¥–∞–µ–º mock handler –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
class MockHandler:
    def __init__(self):
        from api_main import TestAPIHandler
        self.handler = TestAPIHandler(None, None, None)
    
    def test_small_tz(self):
        """–¢–µ—Å—Ç–∏—Ä—É–µ–º –º–∞–ª–µ–Ω—å–∫–æ–µ –¢–ó (–º–µ–Ω—å—à–µ 500 —Å–∏–º–≤–æ–ª–æ–≤)"""
        print("üß™ –¢–ï–°–¢ 1: –ú–∞–ª–µ–Ω—å–∫–æ–µ –¢–ó")
        print("=" * 50)
        
        text = """–ö—Ä–∞—Ç–∫–æ–µ –¢–ó:
1. –°–æ–∑–¥–∞—Ç—å —Å–∏—Å—Ç–µ–º—É
2. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞"""
        
        print(f"–î–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞: {len(text)} —Å–∏–º–≤–æ–ª–æ–≤")
        result = self.handler.stream_text_analysis(text, "test_small")
        print(f"–†–µ–∑—É–ª—å—Ç–∞—Ç: {len(result.get('model_actions', []))} –¥–µ–π—Å—Ç–≤–∏–π")
        return result
    
    def test_medium_tz(self):
        """–¢–µ—Å—Ç–∏—Ä—É–µ–º —Å—Ä–µ–¥–Ω–µ–µ –¢–ó (–Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–±–∑–∞—Ü–µ–≤)"""
        print("\nüß™ –¢–ï–°–¢ 2: –°—Ä–µ–¥–Ω–µ–µ –¢–ó")
        print("=" * 50)
        
        with open("test_tz.txt", "r", encoding="utf-8") as f:
            text = f.read()
        
        print(f"–î–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞: {len(text)} —Å–∏–º–≤–æ–ª–æ–≤")
        result = self.handler.stream_text_analysis(text, "test_medium")
        print(f"–†–µ–∑—É–ª—å—Ç–∞—Ç: {len(result.get('model_actions', []))} –¥–µ–π—Å—Ç–≤–∏–π")
        return result
    
    def test_large_tz(self):
        """–¢–µ—Å—Ç–∏—Ä—É–µ–º –±–æ–ª—å—à–æ–µ –¢–ó (—Ä–∞–∑–±–∏—Ç–æ–µ –Ω–∞ —á–∞–Ω–∫–∏)"""
        print("\nüß™ –¢–ï–°–¢ 3: –ë–æ–ª—å—à–æ–µ –¢–ó")
        print("=" * 50)
        
        with open("large_tz.txt", "r", encoding="utf-8") as f:
            text = f.read()
        
        print(f"–î–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞: {len(text)} —Å–∏–º–≤–æ–ª–æ–≤")
        result = self.handler.stream_text_analysis(text, "test_large")
        print(f"–†–µ–∑—É–ª—å—Ç–∞—Ç: {len(result.get('model_actions', []))} –¥–µ–π—Å—Ç–≤–∏–π")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–∑–¥–∞–ª—Å—è –ª–∏ —Ñ–∞–π–ª
        if os.path.exists("models/test_large.json"):
            print(f"‚úÖ –§–∞–π–ª –º–æ–¥–µ–ª–∏ —Å–æ–∑–¥–∞–Ω: models/test_large.json")
            with open("models/test_large.json", "r", encoding="utf-8") as f:
                model = f.read()
            print(f"üìè –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: {len(model)} —Å–∏–º–≤–æ–ª–æ–≤")
        
        return result
    
    def test_chunk_logic(self):
        """–¢–µ—Å—Ç–∏—Ä—É–µ–º –ª–æ–≥–∏–∫—É —Ä–∞–∑–±–∏–µ–Ω–∏—è –Ω–∞ —á–∞–Ω–∫–∏"""
        print("\nüß™ –¢–ï–°–¢ 4: –õ–æ–≥–∏–∫–∞ —Ä–∞–∑–±–∏–µ–Ω–∏—è –Ω–∞ —á–∞–Ω–∫–∏")
        print("=" * 50)
        
        # –°–æ–∑–¥–∞–µ–º —Ç–µ–∫—Å—Ç —Å —è–≤–Ω—ã–º–∏ —Ä–∞–∑–¥–µ–ª–∞–º–∏
        text = """–ì–õ–ê–í–ê 1. –í–≤–µ–¥–µ–Ω–∏–µ
        
        –≠—Ç–æ –≤–≤–µ–¥–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –º–µ–Ω–µ–µ 500 —Å–∏–º–≤–æ–ª–æ–≤.
        –û–Ω–æ –¥–æ–ª–∂–Ω–æ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å—Å—è —Å–æ —Å–ª–µ–¥—É—é—â–µ–π –≥–ª–∞–≤–æ–π.
        
        –ì–õ–ê–í–ê 2. –û—Å–Ω–æ–≤–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
        
        –≠—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –±–æ–ª–µ–µ 500 —Å–∏–º–≤–æ–ª–æ–≤. 
        –û–Ω –¥–æ–ª–∂–µ–Ω –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–º —á–∞–Ω–∫–æ–º.
        –ó–¥–µ—Å—å –º–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞.
        –ù—É–∂–Ω–æ –¥–æ—Å—Ç–∏—á—å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ —á–∞–Ω–∫–∞.
        –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–æ–±–∞–≤–ª—è—Ç—å —Ç–µ–∫—Å—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
        –ï—â–µ –Ω–µ–º–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –æ–±—ä–µ–º–∞.
        –ò –µ—â–µ –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è –ø–æ–ª–Ω–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏.
        –¢–µ–ø–µ—Ä—å —Ç–æ—á–Ω–æ –¥–æ–ª–∂–Ω–æ —Ö–≤–∞—Ç–∏—Ç—å —Å–∏–º–≤–æ–ª–æ–≤.
        
        –ì–õ–ê–í–ê 3. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ
        
        –ö–æ—Ä–æ—Ç–∫–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ."""
        
        print(f"–î–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞: {len(text)} —Å–∏–º–≤–æ–ª–æ–≤")
        print("\n–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:")
        print("1. –ì–ª–∞–≤–∞ 1 (–º–∞–ª–µ–Ω—å–∫–∞—è) –æ–±—ä–µ–¥–∏–Ω–∏—Ç—Å—è —Å –ì–ª–∞–≤–æ–π 2")
        print("2. –ì–ª–∞–≤–∞ 2 –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç—Å—è –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π —á–∞–Ω–∫")
        print("3. –ì–ª–∞–≤–∞ 3 –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç—Å—è –∫–∞–∫ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞–Ω–∫")
        
        result = self.handler.stream_text_analysis(text, "test_chunks")
        return result

if __name__ == "__main__":
    # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É models –µ—Å–ª–∏ –µ–µ –Ω–µ—Ç
    if not os.path.exists("models"):
        os.makedirs("models")
        print("üìÅ –°–æ–∑–¥–∞–Ω–∞ –ø–∞–ø–∫–∞ models")
    
    tester = MockHandler()
    
    print("üöÄ –ó–ê–ü–£–°–ö –¢–ï–°–¢–û–í –ü–û–¢–û–ö–û–í–û–ì–û –ê–ù–ê–õ–ò–ó–ê –¢–ó")
    print("=" * 60)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
    try:
        tester.test_small_tz()
        tester.test_medium_tz()
        tester.test_large_tz()
        tester.test_chunk_logic()
        
        print("\n" + "=" * 60)
        print("‚úÖ –í–°–ï –¢–ï–°–¢–´ –ó–ê–í–ï–†–®–ï–ù–´!")
        print("\nüìÅ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞–ø–∫—É models/:")
        for file in os.listdir("models"):
            if file.endswith(".json"):
                size = os.path.getsize(f"models/{file}")
                print(f"   - {file} ({size} –±–∞–π—Ç)")
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏: {e}")
        import traceback
        traceback.print_exc()