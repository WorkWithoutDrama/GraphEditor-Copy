<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ç–ª–∞–¥–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –º–æ–¥–µ–ª–∏</title>
    <style>
        body { font-family: monospace; margin: 20px; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 5px; overflow: auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .error { color: #dc3545; }
        .success { color: #28a745; }
        button { padding: 10px 20px; margin: 10px; }
    </style>
</head>
<body>
    <h1>–û—Ç–ª–∞–¥–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –º–æ–¥–µ–ª–∏</h1>
    
    <div class="section">
        <h3>1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤–æ–π –º–æ–¥–µ–ª–∏</h3>
        <button onclick="generateTestModel()">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –º–æ–¥–µ–ª—å</button>
        <div id="testModel"></div>
    </div>
    
    <div class="section">
        <h3>2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –º–æ–¥–µ–ª–∏</h3>
        <button onclick="checkModelStructure()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É</button>
        <div id="structureCheck"></div>
    </div>
    
    <div class="section">
        <h3>3. –°–æ–∑–¥–∞–Ω–∏–µ —É–∑–ª–æ–≤ –∏ —Å–≤—è–∑–µ–π</h3>
        <button onclick="createNodesAndEdges()">–°–æ–∑–¥–∞—Ç—å —É–∑–ª—ã –∏ —Å–≤—è–∑–∏</button>
        <div id="nodesEdgesResult"></div>
    </div>
    
    <script>
        let currentModel = null;
        
        function generateTestModel() {
            // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –º–æ–¥–µ–ª—å –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
            currentModel = {
                model_actions: [
                    {
                        action_id: "a00001",
                        action_name: "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
                        action_links: { manual: "", API: "", UI: "" }
                    },
                    {
                        action_id: "a00002", 
                        action_name: "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
                        action_links: { manual: "", API: "", UI: "" }
                    }
                ],
                model_objects: [
                    {
                        object_id: "o00001",
                        object_name: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
                        resource_state: [
                            { state_id: "s00001", state_name: "–Ω–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω" },
                            { state_id: "s00002", state_name: "–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω" }
                        ]
                    },
                    {
                        object_id: "o00002",
                        object_name: "–°–∏—Å—Ç–µ–º–∞",
                        resource_state: [
                            { state_id: "s00003", state_name: "–æ–∂–∏–¥–∞–µ—Ç" },
                            { state_id: "s00004", state_name: "–æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ" }
                        ]
                    }
                ],
                model_connections: [
                    {
                        connection_out: "o00001s00001",
                        connection_in: "a00001",
                        connection_label: "–∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é"
                    },
                    {
                        connection_out: "a00001",
                        connection_in: "o00001s00002",
                        connection_label: "—Å–æ–∑–¥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
                    },
                    {
                        connection_out: "o00001s00002",
                        connection_in: "a00002",
                        connection_label: "–∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é"
                    },
                    {
                        connection_out: "a00002",
                        connection_in: "o00002s00004",
                        connection_label: "–∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç –≤ —Å–∏—Å—Ç–µ–º–µ"
                    }
                ]
            };
            
            document.getElementById('testModel').innerHTML = `
                <div class="success">
                    <p>‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è –º–æ–¥–µ–ª—å —Å–æ–∑–¥–∞–Ω–∞</p>
                    <button onclick="showModel()">–ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–µ–ª—å</button>
                    <div id="modelDetails" style="display: none;">
                        <pre>${JSON.stringify(currentModel, null, 2)}</pre>
                    </div>
                </div>
            `;
        }
        
        function showModel() {
            const details = document.getElementById('modelDetails');
            details.style.display = details.style.display === 'none' ? 'block' : 'none';
        }
        
        function checkModelStructure() {
            if (!currentModel) {
                document.getElementById('structureCheck').innerHTML = `
                    <div class="error">
                        <p>‚ùå –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –º–æ–¥–µ–ª—å</p>
                    </div>
                `;
                return;
            }
            
            const checks = [];
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–µ–π—Å—Ç–≤–∏—è
            if (!currentModel.model_actions || !Array.isArray(currentModel.model_actions)) {
                checks.push("‚ùå model_actions –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ –º–∞—Å—Å–∏–≤");
            } else {
                currentModel.model_actions.forEach((action, i) => {
                    if (!action.action_id) checks.push(`‚ùå –î–µ–π—Å—Ç–≤–∏–µ ${i}: –Ω–µ—Ç action_id`);
                    if (!action.action_name) checks.push(`‚ùå –î–µ–π—Å—Ç–≤–∏–µ ${i}: –Ω–µ—Ç action_name`);
                    if (!/^a\d{5}$/.test(action.action_id)) checks.push(`‚ùå –î–µ–π—Å—Ç–≤–∏–µ ${i}: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç action_id: ${action.action_id}`);
                });
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—ä–µ–∫—Ç—ã
            if (!currentModel.model_objects || !Array.isArray(currentModel.model_objects)) {
                checks.push("‚ùå model_objects –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ –º–∞—Å—Å–∏–≤");
            } else {
                currentModel.model_objects.forEach((obj, i) => {
                    if (!obj.object_id) checks.push(`‚ùå –û–±—ä–µ–∫—Ç ${i}: –Ω–µ—Ç object_id`);
                    if (!obj.object_name) checks.push(`‚ùå –û–±—ä–µ–∫—Ç ${i}: –Ω–µ—Ç object_name`);
                    if (!/^o\d{5}$/.test(obj.object_id)) checks.push(`‚ùå –û–±—ä–µ–∫—Ç ${i}: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç object_id: ${obj.object_id}`);
                    
                    if (!obj.resource_state || !Array.isArray(obj.resource_state)) {
                        checks.push(`‚ùå –û–±—ä–µ–∫—Ç ${i}: –Ω–µ—Ç resource_state –∏–ª–∏ –Ω–µ –º–∞—Å—Å–∏–≤`);
                    } else {
                        obj.resource_state.forEach((state, j) => {
                            if (!state.state_id) checks.push(`‚ùå –û–±—ä–µ–∫—Ç ${i}, —Å–æ—Å—Ç–æ—è–Ω–∏–µ ${j}: –Ω–µ—Ç state_id`);
                            if (!state.state_name) checks.push(`‚ùå –û–±—ä–µ–∫—Ç ${i}, —Å–æ—Å—Ç–æ—è–Ω–∏–µ ${j}: –Ω–µ—Ç state_name`);
                            if (!/^s\d{5}$/.test(state.state_id)) checks.push(`‚ùå –û–±—ä–µ–∫—Ç ${i}, —Å–æ—Å—Ç–æ—è–Ω–∏–µ ${j}: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç state_id: ${state.state_id}`);
                        });
                    }
                });
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–≤—è–∑–∏
            if (!currentModel.model_connections || !Array.isArray(currentModel.model_connections)) {
                checks.push("‚ùå model_connections –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ –º–∞—Å—Å–∏–≤");
            } else {
                currentModel.model_connections.forEach((conn, i) => {
                    if (!conn.connection_out) checks.push(`‚ùå –°–≤—è–∑—å ${i}: –Ω–µ—Ç connection_out`);
                    if (!conn.connection_in) checks.push(`‚ùå –°–≤—è–∑—å ${i}: –Ω–µ—Ç connection_in`);
                });
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ ID
            const actionIds = new Set(currentModel.model_actions?.map(a => a.action_id) || []);
            const objectIds = new Set(currentModel.model_objects?.map(o => o.object_id) || []);
            
            currentModel.model_connections?.forEach((conn, i) => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º connection_out
                if (conn.connection_out.startsWith('o') && conn.connection_out.includes('s')) {
                    // –≠—Ç–æ —Å–æ—Å—Ç–∞–≤–Ω–æ–π ID —Å–æ—Å—Ç–æ—è–Ω–∏—è
                    const sIndex = conn.connection_out.indexOf('s');
                    const objectId = conn.connection_out.substring(0, sIndex);
                    const stateId = conn.connection_out.substring(sIndex);
                    
                    if (!objectIds.has(objectId)) {
                        checks.push(`‚ùå –°–≤—è–∑—å ${i}: –æ–±—ä–µ–∫—Ç ${objectId} –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`);
                    }
                } else if (conn.connection_out.startsWith('a')) {
                    // –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ
                    if (!actionIds.has(conn.connection_out)) {
                        checks.push(`‚ùå –°–≤—è–∑—å ${i}: –¥–µ–π—Å—Ç–≤–∏–µ ${conn.connection_out} –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`);
                    }
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º connection_in
                if (conn.connection_in.startsWith('o') && conn.connection_in.includes('s')) {
                    const sIndex = conn.connection_in.indexOf('s');
                    const objectId = conn.connection_in.substring(0, sIndex);
                    const stateId = conn.connection_in.substring(sIndex);
                    
                    if (!objectIds.has(objectId)) {
                        checks.push(`‚ùå –°–≤—è–∑—å ${i}: –æ–±—ä–µ–∫—Ç ${objectId} –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`);
                    }
                } else if (conn.connection_in.startsWith('a')) {
                    if (!actionIds.has(conn.connection_in)) {
                        checks.push(`‚ùå –°–≤—è–∑—å ${i}: –¥–µ–π—Å—Ç–≤–∏–µ ${conn.connection_in} –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`);
                    }
                }
            });
            
            let html = '<h4>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏:</h4>';
            if (checks.length === 0) {
                html += '<div class="success">‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã!</div>';
            } else {
                html += '<div class="error"><ul>';
                checks.forEach(check => {
                    html += `<li>${check}</li>`;
                });
                html += '</ul></div>';
            }
            
            document.getElementById('structureCheck').innerHTML = html;
        }
        
        function createNodesAndEdges() {
            if (!currentModel) {
                document.getElementById('nodesEdgesResult').innerHTML = `
                    <div class="error">
                        <p>‚ùå –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –º–æ–¥–µ–ª—å</p>
                    </div>
                `;
                return;
            }
            
            const nodes = [];
            const edges = [];
            const ids = new Set();
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É–∑–ª–æ–≤
            const addNode = (id, label, type) => {
                if (!ids.has(id)) {
                    nodes.push({ data: { id, label: label || id, type } });
                    ids.add(id);
                    console.log(`‚ûï –î–æ–±–∞–≤–ª–µ–Ω —É–∑–µ–ª: ${id} (${label})`);
                }
            };
            
            // 1. –î–æ–±–∞–≤–ª—è–µ–º –¥–µ–π—Å—Ç–≤–∏—è
            currentModel.model_actions.forEach(action => {
                if (action.action_id && action.action_name) {
                    addNode(action.action_id, action.action_name, 'action');
                }
            });
            
            // 2. –î–æ–±–∞–≤–ª—è–µ–º –æ–±—ä–µ–∫—Ç—ã –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            currentModel.model_objects.forEach(obj => {
                if (obj.object_id && obj.object_name && obj.resource_state) {
                    obj.resource_state.forEach(state => {
                        if (state.state_id && state.state_name) {
                            const stateId = `${obj.object_id}${state.state_id}`;
                            const stateLabel = `${obj.object_name}: ${state.state_name}`;
                            addNode(stateId, stateLabel, 'state');
                        }
                    });
                }
            });
            
            // 3. –î–æ–±–∞–≤–ª—è–µ–º —Å–≤—è–∑–∏
            currentModel.model_connections.forEach(conn => {
                if (conn.connection_out && conn.connection_in) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —É–∑–ª–æ–≤
                    const sourceExists = ids.has(conn.connection_out);
                    const targetExists = ids.has(conn.connection_in);
                    
                    if (sourceExists && targetExists) {
                        edges.push({
                            data: {
                                id: `${conn.connection_out}->${conn.connection_in}`,
                                source: conn.connection_out,
                                target: conn.connection_in,
                                label: conn.connection_label || '—Å–≤—è–∑—å'
                            }
                        });
                        console.log(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–≤—è–∑—å: ${conn.connection_out} -> ${conn.connection_in}`);
                    } else {
                        console.warn(`‚ö†Ô∏è  –ü—Ä–æ–ø—É—â–µ–Ω–∞ —Å–≤—è–∑—å: ${conn.connection_out} -> ${conn.connection_in}`);
                        console.warn(`   source —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: ${sourceExists}, target —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: ${targetExists}`);
                        
                        // –ü–æ–ø—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π —É–∑–µ–ª
                        if (!sourceExists && conn.connection_out.startsWith('o') && conn.connection_out.includes('s')) {
                            const sIndex = conn.connection_out.indexOf('s');
                            const objectId = conn.connection_out.substring(0, sIndex);
                            const stateId = conn.connection_out.substring(sIndex);
                            
                            // –ò—â–µ–º –æ–±—ä–µ–∫—Ç
                            const obj = currentModel.model_objects.find(o => o.object_id === objectId);
                            if (obj) {
                                const stateLabel = `${obj.object_name}: —Å–æ—Å—Ç–æ—è–Ω–∏–µ ${stateId.substring(1)}`;
                                addNode(conn.connection_out, stateLabel, 'state');
                                console.log(`‚ûï –°–æ–∑–¥–∞–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π —É–∑–µ–ª: ${conn.connection_out}`);
                            }
                        }
                    }
                }
            });
            
            document.getElementById('nodesEdgesResult').innerHTML = `
                <div class="success">
                    <p>‚úÖ –£–∑–ª—ã –∏ —Å–≤—è–∑–∏ —Å–æ–∑–¥–∞–Ω—ã</p>
                    <p>–£–∑–ª—ã: ${nodes.length}</p>
                    <p>–°–≤—è–∑–∏: ${edges.length}</p>
                    <p>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π</p>
                    <button onclick="showNodesEdges()">–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É</button>
                    <div id="nodesEdgesDetails" style="display: none;">
                        <h4>–£–∑–ª—ã (${nodes.length}):</h4>
                        <pre>${JSON.stringify(nodes.map(n => n.data), null, 2)}</pre>
                        <h4>–°–≤—è–∑–∏ (${edges.length}):</h4>
                        <pre>${JSON.stringify(edges.map(e => e.data), null, 2)}</pre>
                    </div>
                </div>
            `;
            
            // –í—ã–≤–æ–¥–∏–º –≤ –∫–æ–Ω—Å–æ–ª—å
            console.log('üéØ –¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:');
            console.log('–£–∑–ª—ã:', nodes.map(n => n.data));
            console.log('–°–≤—è–∑–∏:', edges.map(e => e.data));
        }
        
        function showNodesEdges() {
            const details = document.getElementById('nodesEdgesDetails');
            details.style.display = details.style.display === 'none' ? 'block' : 'none';
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –º–æ–¥–µ–ª—å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            setTimeout(generateTestModel, 500);
        };
    </script>
</body>
</html>