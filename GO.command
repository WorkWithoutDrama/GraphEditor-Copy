#!/bin/bash

cd "$(dirname "$0")"

echo "========================================"
echo "   üöÄ GRAPH EDITOR - –ü–†–û–°–¢–û–ô –ó–ê–ü–£–°–ö"
echo "========================================"
echo ""

# –£–±–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã, –Ω–æ –Ω–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ
echo "üßπ –û—á–∏—â–∞—é —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã..."

# –£–±–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞—à–∏ –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É 3000
for pid in $(lsof -ti:3000 2>/dev/null); do
    if ps -p $pid > /dev/null; then
        kill -9 $pid 2>/dev/null
        echo "   –£–±–∏—Ç –ø—Ä–æ—Ü–µ—Å—Å $pid –Ω–∞ –ø–æ—Ä—Ç—É 3000"
    fi
done

# –î–ª—è –ø–æ—Ä—Ç–∞ 5000 —É–±–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ python –ø—Ä–æ—Ü–µ—Å—Å—ã
for pid in $(lsof -ti:5000 2>/dev/null); do
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –Ω–∞—à –ø—Ä–æ—Ü–µ—Å—Å (python)
    if ps -p $pid > /dev/null && [[ $(ps -p $pid -o comm= 2>/dev/null) == *"python"* ]]; then
        kill -9 $pid 2>/dev/null
        echo "   –£–±–∏—Ç python –ø—Ä–æ—Ü–µ—Å—Å $pid –Ω–∞ –ø–æ—Ä—Ç—É 5000"
    fi
done

sleep 1

# –ó–∞–ø—É—Å–∫–∞–µ–º API
echo "üîß –ó–∞–ø—É—Å–∫–∞—é AI API..."
python3 api.py &
API_PID=$!

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ API
echo "   ‚è≥ –û–∂–∏–¥–∞—é –∑–∞–ø—É—Å–∫–∞ API..."
for i in {1..10}; do
    if [ -f "api_port.txt" ]; then
        API_PORT=$(cat api_port.txt)
        echo "   ‚úÖ API –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É $API_PORT"
        break
    fi
    sleep 1
    echo -n "."
done
echo ""

if [ ! -f "api_port.txt" ]; then
    echo "   ‚ùå API –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
    echo "   –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –ø–æ—Ä—Ç –∏–ª–∏ –æ—á–∏—Å—Ç–∏—Ç–µ –ø–æ—Ä—Ç—ã"
    exit 1
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–∫—Å–∏
echo "üîß –ó–∞–ø—É—Å–∫–∞—é –ø—Ä–æ–∫—Å–∏..."
node simple-proxy.js &
PROXY_PID=$!
sleep 2

# –û—Ç–∫—Ä—ã–≤–∞–µ–º –±—Ä–∞—É–∑–µ—Ä
echo "üåê –û—Ç–∫—Ä—ã–≤–∞—é Graph Editor..."
open "http://localhost:3000"

echo ""
echo "‚úÖ –ì–û–¢–û–í–û!"
echo ""
echo "üìä –°–ï–†–í–ï–†–´:"
echo "   ‚Ä¢ AI API:    http://localhost:5000"
echo "   ‚Ä¢ –ü—Ä–æ–∫—Å–∏:    http://localhost:3000"
echo ""
echo "üéØ –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï:"
echo "   1. –ù–∞–∂–º–∏—Ç–µ 'Graph Manager' –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ"
echo "   2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã"
echo "   3. AI —Å–æ–∑–¥–∞—Å—Ç –≥—Ä–∞—Ñ–æ–≤—É—é –º–æ–¥–µ–ª—å"
echo ""
echo "üõë –î–õ–Ø –û–°–¢–ê–ù–û–í–ö–ò: –ù–∞–∂–º–∏—Ç–µ Ctrl+C"
echo ""

# –ñ–¥–µ–º
wait