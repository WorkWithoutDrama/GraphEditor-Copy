#!/bin/bash

echo "========================================"
echo "   🧪 ТЕСТ ВЫВОДА ЛОГОВ API"
echo "========================================"
echo ""

# Останавливаем старые процессы
echo "🛑 Останавливаю старые процессы..."
pkill -f "python.*api" 2>/dev/null
sleep 2

echo ""
echo "🚀 ЗАПУСК ТЕСТОВОГО API..."
echo "========================================"

# Запускаем тестовый API в ТЕКУЩЕМ ТЕРМИНАЛЕ
python3 api_test_logs.py &
API_PID=$!

# Ждем запуска
sleep 3

# Проверяем порт
if [ -f "api_port.txt" ]; then
    API_PORT=$(cat api_port.txt)
    echo ""
    echo "✅ API запущен на порту $API_PORT"
else
    echo "❌ Не удалось запустить API"
    exit 1
fi

echo ""
echo "========================================"
echo "🎯 ТЕСТ 1: Проверка здоровья API"
echo "========================================"
curl -s "http://localhost:$API_PORT/api/health"
echo ""

echo ""
echo "========================================"
echo "🎯 ТЕСТ 2: Отправка запроса на генерацию"
echo "========================================"
echo "📤 Отправляю тестовый запрос..."
curl -X POST "http://localhost:$API_PORT/api/generate-model" \
     -H "Content-Type: application/json" \
     -d '{"text":"Тестовый текст для проверки вывода логов в консоль"}' 2>&1

echo ""
echo ""
echo "========================================"
echo "👀 ЧТО ДОЛЖНО БЫТЬ ВИДНО ВЫШЕ:"
echo "========================================"
echo "1. '✅ ТЕСТОВЫЙ API запущен на порту XXXX'"
echo "2. '📥 ПОЛУЧЕН POST ЗАПРОС /api/generate-model'"
echo "3. '📄 Текст запроса: ...'"
echo "4. '🔄 ГЕНЕРАЦИЯ МОДЕЛИ...'"
echo "5. '🎯 СГЕНЕРИРОВАННАЯ МОДЕЛЬ:'"
echo "6. Полный JSON модели"
echo "7. '✅ ОТВЕТ ОТПРАВЛЕН'"
echo ""
echo "🛑 ДЛЯ ОСТАНОВКИ: нажмите Ctrl+C"
echo ""

# Ждем
wait $API_PID