#!/bin/bash

echo "========================================"
echo "   üöÄ GRAPH EDITOR - –ü–†–Ø–ú–û–ô –í–´–í–û–î –õ–û–ì–û–í"
echo "========================================"
echo ""

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã..."
pkill -f "python.*api_with_forced" 2>/dev/null
pkill -f "node proxy-server" 2>/dev/null
sleep 2

echo ""
echo "========================================"
echo "üöÄ –ó–ê–ü–£–°–ö AI API (–í–°–ï –õ–û–ì–ò –ë–£–î–£–¢ –í–ò–î–ù–´):"
echo "========================================"
echo ""

# –ó–∞–ø—É—Å–∫–∞–µ–º API –≤ –¢–ï–ö–£–©–ï–ú –¢–ï–†–ú–ò–ù–ê–õ–ï (–Ω–µ –≤ —Ñ–æ–Ω–µ)
# –ò—Å–ø–æ–ª—å–∑—É–µ–º unbuffered mode –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –í–°–ï –≤—ã–≤–æ–¥—ã
python3 -u api_with_forced_logs.py 2>&1 &
API_PID=$!

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
echo "‚è≥ –ó–∞–ø—É—Å–∫ API... (5 —Å–µ–∫—É–Ω–¥)"
sleep 5

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—Ç
if [ -f "api_port.txt" ]; then
    API_PORT=$(cat api_port.txt)
    echo ""
    echo "‚úÖ API –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É $API_PORT"
    echo "üì° URL: http://localhost:$API_PORT/api/generate-model"
else
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ—Ä—Ç API"
    exit 1
fi

echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é –∑–¥–æ—Ä–æ–≤—å–µ API..."
if curl -s "http://localhost:$API_PORT/api/health" > /dev/null; then
    echo "‚úÖ API –∑–¥–æ—Ä–æ–≤"
else
    echo "‚ùå API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
    exit 1
fi

echo ""
echo "========================================"
echo "üéØ –¢–ï–°–¢–û–í–´–ô –ó–ê–ü–†–û–° –î–õ–Ø –ü–†–û–í–ï–†–ö–ò –õ–û–ì–û–í:"
echo "========================================"
echo ""

# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
echo "üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∫ API..."
curl -X POST "http://localhost:$API_PORT/api/generate-model" \
     -H "Content-Type: application/json" \
     -d '{"text":"–¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—ã–≤–æ–¥–∞ JSON –≤ –ª–æ–≥–∞—Ö"}' 2>&1

echo ""
echo "========================================"
echo "üëÄ –õ–û–ì–ò API –î–û–õ–ñ–ù–´ –ë–´–¢–¨ –í–ò–î–ù–´ –í–´–®–ï!"
echo "========================================"
echo ""
echo "–ï—Å–ª–∏ –≤—ã –Ω–µ –≤–∏–¥–∏—Ç–µ —Å—Ç—Ä–æ–∫ —Å 'üì• –ü–û–õ–£–ß–ï–ù –ó–ê–ü–†–û–°' –∏ 'üéØ –°–ì–ï–ù–ï–†–ò–†–û–í–ê–ù–ù–ê–Ø –ú–û–î–ï–õ–¨',"
echo "–∑–Ω–∞—á–∏—Ç –ø—Ä–æ–±–ª–µ–º–∞ –≤ –≤—ã–≤–æ–¥–µ API."
echo ""
echo "üìã –ß–¢–û –î–ï–õ–ê–¢–¨ –î–ê–õ–¨–®–ï:"
echo "1. –û—Ç–∫—Ä–æ–π—Ç–µ –Ω–æ–≤—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª"
echo "2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ–∫—Å–∏: node proxy-server.js"
echo "3. –û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä: http://localhost:3000/proxy-index.html"
echo "4. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –º–æ–¥–µ–ª—å —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å"
echo "5. –°–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ API –≤ –≠–¢–û–ú –æ–∫–Ω–µ"
echo ""
echo "üõë –î–õ–Ø –û–°–¢–ê–ù–û–í–ö–ò API: –Ω–∞–∂–º–∏—Ç–µ Ctrl+C –≤ —ç—Ç–æ–º –æ–∫–Ω–µ"

# –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è API
wait $API_PID