#!/bin/bash

echo "========================================"
echo "   üêõ –û–¢–õ–ê–î–ö–ê API –ò –í–´–í–û–î–ê –õ–û–ì–û–í"
echo "========================================"
echo ""

# 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–∏–µ –ø–æ—Ä—Ç—ã —Å–ª—É—à–∞—é—Ç
echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é –ø–æ—Ä—Ç—ã API:"
for port in {5001..5010}; do
    if curl -s --connect-timeout 1 "http://localhost:$port/api/health" > /dev/null; then
        echo "‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É $port"
        API_PORT=$port
    fi
done

if [ -z "$API_PORT" ]; then
    echo "‚ùå API –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ –ø–æ—Ä—Ç–∞—Ö 5001-5010"
    exit 1
fi

echo ""
echo "========================================"
echo "üéØ –¢–ï–°–¢ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è API"
echo "========================================"
curl -v "http://localhost:$API_PORT/api/health"
echo ""

echo ""
echo "========================================"
echo "üéØ –¢–ï–°–¢ 2: –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–æ—Å—Ç–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞"
echo "========================================"
echo "üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é POST –∑–∞–ø—Ä–æ—Å –Ω–∞–ø—Ä—è–º—É—é..."
curl -v -X POST "http://localhost:$API_PORT/api/generate-model" \
     -H "Content-Type: application/json" \
     -d '{"text":"–¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏"}' 2>&1 | head -50

echo ""
echo "========================================"
echo "üéØ –¢–ï–°–¢ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞ api_port.txt"
echo "========================================"
if [ -f "api_port.txt" ]; then
    FILE_PORT=$(cat api_port.txt)
    echo "–§–∞–π–ª api_port.txt —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ—Ä—Ç: $FILE_PORT"
    echo "–¢–µ–∫—É—â–∏–π —Ä–∞–±–æ—Ç–∞—é—â–∏–π –ø–æ—Ä—Ç: $API_PORT"
    if [ "$FILE_PORT" != "$API_PORT" ]; then
        echo "‚ùå –ù–ï–°–û–û–¢–í–ï–¢–°–¢–í–ò–ï: —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç $FILE_PORT, –Ω–æ API –Ω–∞ $API_PORT"
    else
        echo "‚úÖ –ü–æ—Ä—Ç—ã —Å–æ–≤–ø–∞–¥–∞—é—Ç"
    fi
else
    echo "‚ùå –§–∞–π–ª api_port.txt –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
fi

echo ""
echo "========================================"
echo "üéØ –¢–ï–°–¢ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ graph-manager.js"
echo "========================================"
echo "–ü—Ä–æ–≤–µ—Ä—è—é, –∫–∞–∫–æ–π –ø–æ—Ä—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç GraphManager..."
if grep -n "apiBaseUrl" graph-manager.js | head -5; then
    echo ""
    echo "–¢–µ–∫—É—â–∏–π apiBaseUrl –≤ graph-manager.js:"
    grep "apiBaseUrl = " graph-manager.js
fi

echo ""
echo "========================================"
echo "üìã –í–´–í–û–î–´:"
echo "========================================"
echo "1. –ï—Å–ª–∏ API –Ω–µ –≤—ã–≤–æ–¥–∏—Ç 'üì• –ü–û–õ–£–ß–ï–ù –ó–ê–ü–†–û–°' - –∑–Ω–∞—á–∏—Ç –∑–∞–ø—Ä–æ—Å –Ω–µ –¥–æ—Ö–æ–¥–∏—Ç"
echo "2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ GraphManager –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—Ç"
echo "3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏"
echo "4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø—Ä–æ–∫—Å–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—Ç"