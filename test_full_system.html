<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –ø–æ–ª–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 20px; margin: 10px; cursor: pointer; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 5px; overflow: auto; font-size: 12px; }
        .log { font-family: monospace; white-space: pre-wrap; background: #f8f9fa; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>–¢–µ—Å—Ç –ø–æ–ª–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–æ–¥–µ–ª–∏</h1>
    
    <div class="test-section" id="section1">
        <h3>1. –¢–µ—Å—Ç API –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–æ–¥–µ–ª–∏</h3>
        <button onclick="testAPIGeneration()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
        <div id="apiResult"></div>
    </div>
    
    <div class="test-section" id="section2">
        <h3>2. –¢–µ—Å—Ç –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –≥—Ä–∞—Ñ–∞</h3>
        <button onclick="testGraphRendering()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
        <div id="graphResult"></div>
    </div>
    
    <div class="test-section" id="section3">
        <h3>3. –¢–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–æ–¥–µ–ª–∏</h3>
        <button onclick="testModelSaving()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
        <div id="saveResult"></div>
    </div>
    
    <div class="test-section" id="section4">
        <h3>4. –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã</h3>
        <button onclick="runFullTest()">–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ç–µ—Å—Ç</button>
        <div id="fullResult"></div>
    </div>
    
    <div class="test-section">
        <h3>–õ–æ–≥–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</h3>
        <div id="log" class="log"></div>
    </div>
    
    <script>
        let currentModel = null;
        const logElement = document.getElementById('log');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logElement.innerHTML += `<div style="color:${color}">[${timestamp}] ${message}</div>`;
        }
        
        function clearResults() {
            document.getElementById('apiResult').innerHTML = '';
            document.getElementById('graphResult').innerHTML = '';
            document.getElementById('saveResult').innerHTML = '';
            document.getElementById('fullResult').innerHTML = '';
            logElement.innerHTML = '';
        }
        
        async function testAPIGeneration() {
            clearResults();
            log('üîç –¢–µ—Å—Ç–∏—Ä—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –º–æ–¥–µ–ª–∏ —á–µ—Ä–µ–∑ API...');
            
            try {
                const response = await fetch('http://localhost:5003/api/generate-model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        text: '–¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –ó–ê–î–ê–ù–ò–ï (–¢–ó) –Ω–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É –∫–ª–∏–µ–Ω—Ç-—Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è "Mindful Meals"' 
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP –æ—à–∏–±–∫–∞: ${response.status}`);
                }
                
                const data = await response.json();
                currentModel = data.model;
                
                log('‚úÖ API –æ—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω');
                log(`–î–µ–π—Å—Ç–≤–∏–π: ${data.model.model_actions.length}`);
                log(`–û–±—ä–µ–∫—Ç–æ–≤: ${data.model.model_objects.length}`);
                log(`–°–≤—è–∑–µ–π: ${data.model.model_connections.length}`);
                
                document.getElementById('apiResult').innerHTML = `
                    <div class="success">
                        <p>‚úÖ API —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª –º–æ–¥–µ–ª—å!</p>
                        <p>–î–µ–π—Å—Ç–≤–∏–π: ${data.model.model_actions.length}</p>
                        <p>–û–±—ä–µ–∫—Ç–æ–≤: ${data.model.model_objects.length}</p>
                        <p>–°–≤—è–∑–µ–π: ${data.model.model_connections.length}</p>
                        <button onclick="showModelDetails()">–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –º–æ–¥–µ–ª–∏</button>
                    </div>
                `;
                
                document.getElementById('section1').classList.add('success');
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ API: ${error.message}`, 'error');
                document.getElementById('apiResult').innerHTML = `
                    <div class="error">
                        <p>‚ùå –û—à–∏–±–∫–∞ API: ${error.message}</p>
                    </div>
                `;
                document.getElementById('section1').classList.add('error');
            }
        }
        
        function showModelDetails() {
            if (!currentModel) return;
            
            const details = `
                <h4>–î–µ—Ç–∞–ª–∏ –º–æ–¥–µ–ª–∏:</h4>
                <pre>${JSON.stringify(currentModel, null, 2)}</pre>
            `;
            
            document.getElementById('apiResult').innerHTML += details;
        }
        
        function testGraphRendering() {
            clearResults();
            log('üîç –¢–µ—Å—Ç–∏—Ä—É—é –æ—Ç—Ä–∏—Å–æ–≤–∫—É –≥—Ä–∞—Ñ–∞...');
            
            if (!currentModel) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –º–æ–¥–µ–ª—å —á–µ—Ä–µ–∑ API', 'error');
                document.getElementById('graphResult').innerHTML = `
                    <div class="error">
                        <p>‚ùå –°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –º–æ–¥–µ–ª—å —á–µ—Ä–µ–∑ API</p>
                    </div>
                `;
                return;
            }
            
            // –ü—Ä–æ—Å—Ç–∞—è —Å–∏–º—É–ª—è—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
            const nodes = [];
            const edges = [];
            
            // –î–µ–π—Å—Ç–≤–∏—è
            currentModel.model_actions.forEach(action => {
                if (action.action_id && action.action_name) {
                    nodes.push({
                        id: action.action_id,
                        label: action.action_name,
                        type: 'action'
                    });
                }
            });
            
            // –û–±—ä–µ–∫—Ç—ã –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            currentModel.model_objects.forEach(obj => {
                if (obj.object_id && obj.object_name && obj.resource_state) {
                    obj.resource_state.forEach(state => {
                        if (state.state_id && state.state_name) {
                            const stateId = `${obj.object_id}${state.state_id}`;
                            nodes.push({
                                id: stateId,
                                label: `${obj.object_name}: ${state.state_name}`,
                                type: 'state'
                            });
                        }
                    });
                }
            });
            
            // –°–≤—è–∑–∏
            currentModel.model_connections.forEach(conn => {
                if (conn.connection_out && conn.connection_in) {
                    edges.push({
                        source: conn.connection_out,
                        target: conn.connection_in
                    });
                }
            });
            
            log(`‚úÖ –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≥—Ä–∞—Ñ–∞:`);
            log(`–£–∑–ª—ã: ${nodes.length} (${nodes.filter(n => n.type === 'action').length} –¥–µ–π—Å—Ç–≤–∏–π, ${nodes.filter(n => n.type === 'state').length} —Å–æ—Å—Ç–æ—è–Ω–∏–π)`);
            log(`–°–≤—è–∑–∏: ${edges.length}`);
            
            document.getElementById('graphResult').innerHTML = `
                <div class="success">
                    <p>‚úÖ –ì—Ä–∞—Ñ –≥–æ—Ç–æ–≤ –∫ –æ—Ç—Ä–∏—Å–æ–≤–∫–µ!</p>
                    <p>–£–∑–ª—ã: ${nodes.length}</p>
                    <p>–°–≤—è–∑–∏: ${edges.length}</p>
                </div>
            `;
            
            document.getElementById('section2').classList.add('success');
        }
        
        function testModelSaving() {
            clearResults();
            log('üîç –¢–µ—Å—Ç–∏—Ä—É—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏...');
            
            if (!currentModel) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –º–æ–¥–µ–ª—å', 'error');
                return;
            }
            
            // –¢–µ—Å—Ç–∏—Ä—É–µ–º –ª–æ–≥–∏–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑ script.js
            const output = {
                model_actions: [],
                model_objects: [],
                model_connections: []
            };
            
            // 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–µ–π—Å—Ç–≤–∏—è
            currentModel.model_actions.forEach(action => {
                output.model_actions.push({
                    action_id: action.action_id,
                    action_name: action.action_name,
                    action_links: action.action_links || { manual: "", API: "", UI: "" }
                });
            });
            
            // 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—ä–µ–∫—Ç—ã –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            currentModel.model_objects.forEach(obj => {
                output.model_objects.push({
                    object_id: obj.object_id,
                    object_name: obj.object_name,
                    resource_state: obj.resource_state || [],
                    object_links: { manual: "", API: "", UI: "" }
                });
            });
            
            // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–≤—è–∑–∏
            currentModel.model_connections.forEach(conn => {
                output.model_connections.push({
                    connection_out: conn.connection_out,
                    connection_in: conn.connection_in,
                    connection_label: conn.connection_label || "—Å–≤—è–∑—å"
                });
            });
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ
            const originalJSON = JSON.stringify(currentModel, null, 2);
            const savedJSON = JSON.stringify(output, null, 2);
            const isSame = originalJSON === savedJSON;
            
            log(`‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å:`);
            log(`–î–µ–π—Å—Ç–≤–∏–π: ${output.model_actions.length} (${isSame ? '‚úì' : '‚úó'} —Å–æ–≤–ø–∞–¥–∞–µ—Ç)`);
            log(`–û–±—ä–µ–∫—Ç–æ–≤: ${output.model_objects.length} (${isSame ? '‚úì' : '‚úó'} —Å–æ–≤–ø–∞–¥–∞–µ—Ç)`);
            log(`–°–≤—è–∑–µ–π: ${output.model_connections.length} (${isSame ? '‚úì' : '‚úó'} —Å–æ–≤–ø–∞–¥–∞–µ—Ç)`);
            
            if (!isSame) {
                log('‚ö†Ô∏è  –í–Ω–∏–º–∞–Ω–∏–µ: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∏—Å—Ö–æ–¥–Ω–æ–π!', 'error');
                log('–ò—Å—Ö–æ–¥–Ω–∞—è:', 'error');
                log(originalJSON.substring(0, 500) + '...');
                log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è:', 'error');
                log(savedJSON.substring(0, 500) + '...');
            }
            
            document.getElementById('saveResult').innerHTML = `
                <div class="${isSame ? 'success' : 'error'}">
                    <p>${isSame ? '‚úÖ' : '‚ùå'} –ú–æ–¥–µ–ª—å ${isSame ? '—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ' : '—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —Å –æ—à–∏–±–∫–∞–º–∏'}</p>
                    <p>–î–µ–π—Å—Ç–≤–∏–π: ${output.model_actions.length}</p>
                    <p>–û–±—ä–µ–∫—Ç–æ–≤: ${output.model_objects.length}</p>
                    <p>–°–≤—è–∑–µ–π: ${output.model_connections.length}</p>
                    <button onclick="showSavedModel()">–ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å</button>
                </div>
            `;
            
            document.getElementById('section3').classList.add(isSame ? 'success' : 'error');
        }
        
        function showSavedModel() {
            if (!currentModel) return;
            
            const output = {
                model_actions: currentModel.model_actions.map(a => ({
                    action_id: a.action_id,
                    action_name: a.action_name,
                    action_links: a.action_links || { manual: "", API: "", UI: "" }
                })),
                model_objects: currentModel.model_objects.map(o => ({
                    object_id: o.object_id,
                    object_name: o.object_name,
                    resource_state: o.resource_state || [],
                    object_links: { manual: "", API: "", UI: "" }
                })),
                model_connections: currentModel.model_connections.map(c => ({
                    connection_out: c.connection_out,
                    connection_in: c.connection_in,
                    connection_label: c.connection_label || "—Å–≤—è–∑—å"
                }))
            };
            
            const details = `
                <h4>–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å:</h4>
                <pre>${JSON.stringify(output, null, 2)}</pre>
            `;
            
            document.getElementById('saveResult').innerHTML += details;
        }
        
        async function runFullTest() {
            clearResults();
            log('üöÄ –ó–∞–ø—É—Å–∫–∞—é –ø–æ–ª–Ω—ã–π —Ç–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã...');
            
            try {
                // 1. –¢–µ—Å—Ç API
                log('1. –¢–µ—Å—Ç–∏—Ä—É—é API...');
                await testAPIGeneration();
                if (!currentModel) throw new Error('API –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª –º–æ–¥–µ–ª—å');
                
                // 2. –¢–µ—Å—Ç –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
                log('2. –¢–µ—Å—Ç–∏—Ä—É—é –æ—Ç—Ä–∏—Å–æ–≤–∫—É...');
                testGraphRendering();
                
                // 3. –¢–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                log('3. –¢–µ—Å—Ç–∏—Ä—É—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');
                testModelSaving();
                
                log('‚úÖ –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!', 'success');
                document.getElementById('fullResult').innerHTML = `
                    <div class="success">
                        <h4>‚úÖ –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã –ø—Ä–æ–π–¥–µ–Ω!</h4>
                        <p>–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.</p>
                    </div>
                `;
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –≤ –ø–æ–ª–Ω–æ–º —Ç–µ—Å—Ç–µ: ${error.message}`, 'error');
                document.getElementById('fullResult').innerHTML = `
                    <div class="error">
                        <h4>‚ùå –û—à–∏–±–∫–∞ –≤ –ø–æ–ª–Ω–æ–º —Ç–µ—Å—Ç–µ</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            log('–°–∏—Å—Ç–µ–º–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≥–æ—Ç–æ–≤–∞. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ç–µ—Å—Ç" –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.');
        };
    </script>
</body>
</html>