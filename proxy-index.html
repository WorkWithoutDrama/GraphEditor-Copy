<!DOCTYPE html>
<html>
<head>
    <title>Graph Editor (via Proxy)</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js"></script>
    <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
</head>
<body>

    <div class="controls">
        <button id="loadButton" class="primary">–í—ã–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
        <input type="file" id="fileInput" accept=".json" style="display: none;">
        <button id="saveButton" class="primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
        <button id="addActionButton">–î–æ–±–∞–≤–∏—Ç—å –î–µ–π—Å—Ç–≤–∏–µ</button>
        <button id="addStateButton">–î–æ–±–∞–≤–∏—Ç—å –û–±—ä–µ–∫—Ç</button>
        <button id="addLinkButton" class="success">+ –°–≤—è–∑—å (1 ‚Üí 2)</button>
        <button id="removeLinkButton" class="danger">- –°–≤—è–∑—å</button>
        <button id="deleteSelectedButton" class="danger">–£–¥–∞–ª–∏—Ç—å (Del)</button>
        <button id="runLayoutButton">–û–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–ø–æ–Ω–æ–≤–∫—É</button>
        <button id="graphManagerButton" class="primary">Graph Manager</button>
        <span class="hint">–°–Ω–∞—á–∞–ª–∞ –∫–ª–∏–∫ –Ω–∞ <b>–ò—Å—Ç–æ—á–Ω–∏–∫</b>, –∑–∞—Ç–µ–º –Ω–∞ <b>–¶–µ–ª—å</b>.</span>
    </div>

    <div class="main-container">
        <div id="cy"></div>
        
        <div class="resizer" id="resizer"></div>
        
        <div class="chat-container" id="chatContainer" style="display: none;">
            <div class="chat-header">
                <h3>Graph Manager</h3>
                <div class="chat-header-buttons">
                    <button class="header-btn" id="clearChatBtn" title="–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é">üóëÔ∏è</button>
                    <button class="close-btn" id="closeChatBtn">√ó</button>
                </div>
            </div>
            <div class="chat-messages" id="chatMessages">
                <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ -->
            </div>
            <div class="chat-input-container">
                <textarea id="chatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª..."></textarea>
                <div class="chat-actions">
                    <input type="file" id="fileUpload" accept=".txt,.md,.pdf" style="display: none;">
                    <button id="uploadFileBtn" class="secondary">üìé –§–∞–π–ª</button>
                    <button id="sendMessageBtn" class="primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∫—Ä–∏–ø—Ç—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—É—Ç—è–º–∏ -->
    <script>
        // –ë–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—É—Ç–µ–π
        window.API_BASE_URL = 'http://localhost:3000';
    </script>
    <script src="script.js"></script>
    <script src="graph-manager.js"></script>
    
    <script>
        // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º GraphManager –¥–ª—è —Ä–∞–±–æ—Ç—ã —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏
        class ProxyGraphManager extends window.GraphManager {
            async checkAPIStatus() {
                try {
                    const response = await fetch(`${window.API_BASE_URL}/api/health`, {
                        method: 'GET',
                        mode: 'cors',
                        cache: 'no-cache'
                    });
                    
                    this.apiAvailable = response.ok;
                    console.log(this.apiAvailable ? '‚úÖ API –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏' : '‚ö†Ô∏è API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    const welcomeMessage = document.querySelector('.bot-message');
                    if (welcomeMessage) {
                        welcomeMessage.textContent = this.apiAvailable ? 
                            'üëã Graph Manager –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä!' :
                            'üëã Graph Manager –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ (API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)';
                    }
                    
                } catch (error) {
                    this.apiAvailable = false;
                    console.log('‚ùå API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', error.message);
                }
            }
            
            async generateModelFromText(text) {
                try {
                    const response = await fetch(`${window.API_BASE_URL}/api/generate-model`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text }),
                        mode: 'cors'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error: ${response.status}`);
                    }
                    
                    return await response.json();
                    
                } catch (error) {
                    console.log('API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É—é –¥–µ–º–æ-—Ä–µ–∂–∏–º:', error.message);
                    
                    // Fallback –Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –º–µ—Ç–æ–¥
                    return super.generateModelFromText(text);
                }
            }
        }
        
        // –ó–∞–º–µ–Ω—è–µ–º GraphManager –Ω–∞ ProxyGraphManager
        window.GraphManager = ProxyGraphManager;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
        window.addEventListener('DOMContentLoaded', () => {
            // –£–∂–µ –µ—Å—Ç—å renderGraph –≤—ã–∑–æ–≤ –≤ script.js
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º GraphManager
            if (window.graphManager) {
                window.graphManager = new ProxyGraphManager();
            }
        });
    </script>
</body>
</html>