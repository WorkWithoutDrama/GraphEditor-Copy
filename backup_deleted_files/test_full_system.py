#!/usr/bin/env python3
"""
–§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ JSON –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –≥—Ä–∞—Ñ–∞
"""

import json
import os
import sys

def test_system_rules():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –ø—Ä–∞–≤–∏–ª —Å–∏—Å—Ç–µ–º—ã"""
    
    print("=" * 60)
    print("üß™ –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –°–ò–°–¢–ï–ú–´")
    print("=" * 60)
    
    rules = {
        "1. –ü—Ä–æ–º–ø—Ç –¥–æ–ª–∂–µ–Ω –Ω–∞—Ö–æ–¥–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ –∏ —É—Å–ª–æ–≤–∏—è": {
            "check": "–ü—Ä–æ–º–ø—Ç –∏—â–µ—Ç –æ–¥–Ω–æ –æ—Å–Ω–æ–≤–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ",
            "files": ["api-fixed-new-structure.py"],
            "keywords": ["–æ—Å–Ω–æ–≤–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ", "–Ω–∞—á–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π", "–∫–æ–Ω–µ—á–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π"]
        },
        "2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –º–æ–¥–µ–ª—å": {
            "check": "–ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç–∞ –Ω–µ—Ç - –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ JSON",
            "files": ["api-fixed-new-structure.py"],
            "keywords": ["–¥–æ–±–∞–≤—å", "–µ—Å–ª–∏ –Ω–µ—Ç", "model_actions", "model_objects"]
        },
        "3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ JSON –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è": {
            "check": "model_actions, model_objects, model_connections",
            "files": ["new-json-structure-example.json", "test_new_prompt.py"],
            "keywords": ["model_actions", "model_objects", "model_connections"]
        },
        "4. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π –≤ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞—Ö": {
            "check": "script.js —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç–∏–ª–∏ –¥–ª—è –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤",
            "files": ["script.js"],
            "keywords": ["node[type=\"action\"]", "rectangle"]
        },
        "5. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤+—Å–æ—Å—Ç–æ—è–Ω–∏–π –≤ –æ–≤–∞–ª–∞—Ö": {
            "check": "script.js —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç–∏–ª–∏ –¥–ª—è –æ–≤–∞–ª–æ–≤",
            "files": ["script.js"],
            "keywords": ["node[type=\"state\"]", "ellipse"]
        },
        "6. –°—Ç—Ä–µ–ª–∫–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç connection_in/connection_out": {
            "check": "graph-manager.js –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–≤—è–∑–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ",
            "files": ["graph-manager.js"],
            "keywords": ["connection_out", "connection_in", "source", "target"]
        }
    }
    
    passed = 0
    total = len(rules)
    
    for rule_name, rule_data in rules.items():
        print(f"\nüìã –ü—Ä–æ–≤–µ—Ä–∫–∞: {rule_name}")
        print(f"   ‚öôÔ∏è  {rule_data['check']}")
        
        all_passed = True
        for filename in rule_data['files']:
            if os.path.exists(filename):
                try:
                    with open(filename, 'r', encoding='utf-8') as f:
                        content = f.read()
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
                    missing = []
                    for keyword in rule_data['keywords']:
                        if keyword not in content:
                            missing.append(keyword)
                    
                    if missing:
                        print(f"   ‚ùå {filename}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: {', '.join(missing)}")
                        all_passed = False
                    else:
                        print(f"   ‚úÖ {filename}: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞")
                except Exception as e:
                    print(f"   ‚ùå {filename}: –æ—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è: {e}")
                    all_passed = False
            else:
                print(f"   ‚ö†Ô∏è  {filename}: —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω")
                all_passed = False
        
        if all_passed:
            print(f"   ‚úÖ –ü—Ä–∞–≤–∏–ª–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è")
            passed += 1
        else:
            print(f"   ‚ùå –ü—Ä–∞–≤–∏–ª–æ –Ω–∞—Ä—É—à–µ–Ω–æ")
    
    print("\n" + "=" * 60)
    print(f"üìä –†–ï–ó–£–õ–¨–¢–ê–¢: {passed}/{total} –ø—Ä–∞–≤–∏–ª –≤—ã–ø–æ–ª–Ω–µ–Ω—ã")
    
    if passed == total:
        print("üéâ –í–°–ï –ü–†–ê–í–ò–õ–ê –í–´–ü–û–õ–ù–ï–ù–´! –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ.")
    else:
        print(f"‚ö†Ô∏è  –ù—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å {total - passed} –ø—Ä–∞–≤–∏–ª")
    
    return passed == total

def generate_sample_json():
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ—Ä–Ω–æ–≥–æ JSON –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏"""
    
    print("\n" + "=" * 60)
    print("üîÑ –ì–ï–ù–ï–†–ê–¶–ò–Ø –ü–†–ò–ú–ï–†–ù–û–ì–û JSON")
    print("=" * 60)
    
    sample_model = {
        "model_actions": [
            {
                "action_id": "a00001",
                "action_name": "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
                "action_links": {
                    "manual": "–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏",
                    "API": "/api/register",
                    "UI": "/register"
                }
            }
        ],
        "model_objects": [
            {
                "object_id": "o00001",
                "object_name": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
                "resource_state": [
                    {"state_id": "s00001", "state_name": "–Ω–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω"},
                    {"state_id": "s00002", "state_name": "–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω"}
                ],
                "object_links": {
                    "manual": "–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º",
                    "API": "/api/users",
                    "UI": "/profile"
                }
            },
            {
                "object_id": "o00002",
                "object_name": "–°–∏—Å—Ç–µ–º–∞",
                "resource_state": [
                    {"state_id": "s00003", "state_name": "–æ–∂–∏–¥–∞–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏"},
                    {"state_id": "s00004", "state_name": "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω"}
                ],
                "object_links": {
                    "manual": "–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã",
                    "API": "/api/system",
                    "UI": "/admin"
                }
            }
        ],
        "model_connections": [
            {
                "connection_out": "o00001s00001",  # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
                "connection_in": "a00001"          # -> –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
            },
            {
                "connection_out": "a00001",        # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                "connection_in": "o00001s00002"    # -> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
            },
            {
                "connection_out": "a00001",        # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                "connection_in": "o00002s00004"    # -> –°–∏—Å—Ç–µ–º–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
            }
        ]
    }
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏–º–µ—Ä
    with open("sample_model_correct.json", "w", encoding="utf-8") as f:
        json.dump(sample_model, f, ensure_ascii=False, indent=2)
    
    print("‚úÖ –ü—Ä–∏–º–µ—Ä JSON —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ sample_model_correct.json")
    print("\nüìù –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–∏–º–µ—Ä–∞:")
    print("   ‚Ä¢ 1 –¥–µ–π—Å—Ç–≤–∏–µ (–ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫)")
    print("   ‚Ä¢ 2 –æ–±—ä–µ–∫—Ç–∞ —Å —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ (–æ–≤–∞–ª—ã)")
    print("   ‚Ä¢ 3 —Å–≤—è–∑–∏ (—Å—Ç—Ä–µ–ª–∫–∏)")
    print("   ‚Ä¢ connection_in –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ—Å—Ç–∞–≤–Ω—ã–µ ID: o12345s12345")

def create_implementation_guide():
    """–°–æ–∑–¥–∞–Ω–∏–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞ –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏"""
    
    guide = """
üìã –†–£–ö–û–í–û–î–°–¢–í–û –ü–û –†–ï–ê–õ–ò–ó–ê–¶–ò–ò –°–ò–°–¢–ï–ú–´

1. ‚úÖ –ü–†–û–ú–ü–¢ –í API (api-fixed-new-structure.py):
   - –ù–∞—Ö–æ–¥–∏—Ç –æ–¥–Ω–æ –æ—Å–Ω–æ–≤–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –≤ –æ–ø–∏—Å–∞–Ω–∏–∏
   - –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∞—á–∞–ª—å–Ω—ã–µ –∏ –∫–æ–Ω–µ—á–Ω—ã–µ —É—Å–ª–æ–≤–∏—è
   - –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –º–æ–¥–µ–ª—å
   - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç JSON —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π

2. ‚úÖ –°–¢–†–£–ö–¢–£–†–ê JSON:
   {
     "model_actions": [    // –î–µ–π—Å—Ç–≤–∏—è –≤ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞—Ö
       {
         "action_id": "a12345",
         "action_name": "–ù–∞–∑–≤–∞–Ω–∏–µ",
         "action_links": {"manual": "", "API": "", "UI": ""}
       }
     ],
     "model_objects": [    // –û–±—ä–µ–∫—Ç—ã+—Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ –æ–≤–∞–ª–∞—Ö
       {
         "object_id": "o12345",
         "object_name": "–û–±—ä–µ–∫—Ç",
         "resource_state": [
           {"state_id": "s12345", "state_name": "–°–æ—Å—Ç–æ—è–Ω–∏–µ"}
         ],
         "object_links": {"manual": "", "API": "", "UI": ""}
       }
     ],
     "model_connections": [    // –°—Ç—Ä–µ–ª–∫–∏ –º–µ–∂–¥—É —É–∑–ª–∞–º–∏
       {
         "connection_out": "–∏—Å—Ç–æ—á–Ω–∏–∫",
         "connection_in": "—Ü–µ–ª—å"  // —Ñ–æ—Ä–º–∞—Ç: o12345s12345
       }
     ]
   }

3. ‚úÖ –û–¢–†–ò–°–û–í–ö–ê –ì–†–ê–§–ê:
   - –î–µ–π—Å—Ç–≤–∏—è ‚Üí –ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∏ (script.js: node[type="action"])
   - –û–±—ä–µ–∫—Ç+—Å–æ—Å—Ç–æ—è–Ω–∏–µ ‚Üí –û–≤–∞–ª—ã (script.js: node[type="state"])
   - –°—Ç—Ä–µ–ª–∫–∏ ‚Üí connection_in (–Ω–∞—á–∞–ª–æ) ‚Üí connection_out (–∫–æ–Ω–µ—Ü)
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ graph-manager.js: processGraphResponse()

4. ‚úÖ –î–û–ë–ê–í–õ–ï–ù–ò–ï –ù–û–í–´–• –≠–õ–ï–ú–ï–ù–¢–û–í:
   - –ï—Å–ª–∏ –¥–µ–π—Å—Ç–≤–∏—è –Ω–µ—Ç –≤ model_actions ‚Üí –¥–æ–±–∞–≤–∏—Ç—å
   - –ï—Å–ª–∏ –æ–±—ä–µ–∫—Ç–∞ –Ω–µ—Ç –≤ model_objects ‚Üí –¥–æ–±–∞–≤–∏—Ç—å
   - –ï—Å–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–µ—Ç –≤ resource_state ‚Üí –¥–æ–±–∞–≤–∏—Ç—å
   - –û–±–Ω–æ–≤–∏—Ç—å model_connections

5. ‚úÖ –ü–†–û–í–ï–†–ö–ò:
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: test_new_prompt.py
   - –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã: test_validation.py
   - –ü—Ä–∏–º–µ—Ä: sample_model_correct.json

–°–ò–°–¢–ï–ú–ê –ì–û–¢–û–í–ê –ö –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ! üéØ
"""
    
    with open("IMPLEMENTATION_GUIDE.md", "w", encoding="utf-8") as f:
        f.write(guide)
    
    print("\nüìò –†–£–ö–û–í–û–î–°–¢–í–û –°–û–ó–î–ê–ù–û: IMPLEMENTATION_GUIDE.md")

if __name__ == "__main__":
    print("\nüîç –ó–ê–ü–£–°–ö –§–ò–ù–ê–õ–¨–ù–û–ô –ü–†–û–í–ï–†–ö–ò...\n")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∏–ª–∞
    system_ok = test_system_rules()
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–∏–º–µ—Ä
    generate_sample_json()
    
    # –°–æ–∑–¥–∞–µ–º —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ
    create_implementation_guide()
    
    # –ò—Ç–æ–≥
    print("\n" + "=" * 60)
    if system_ok:
        print("üéâ –í–°–ï –ü–†–û–í–ï–†–ö–ò –ü–†–û–ô–î–ï–ù–´! –°–∏—Å—Ç–µ–º–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º.")
        print("\n–°–ò–°–¢–ï–ú–ê –£–ú–ï–ï–¢:")
        print("1. üîç –ù–∞—Ö–æ–¥–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ –≤ –ø—Ä–æ–º–ø—Ç–µ")
        print("2. üìã –û–ø—Ä–µ–¥–µ–ª—è—Ç—å –Ω–∞—á–∞–ª—å–Ω—ã–µ –∏ –∫–æ–Ω–µ—á–Ω—ã–µ —É—Å–ª–æ–≤–∏—è")
        print("3. ‚ûï –î–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –º–æ–¥–µ–ª—å")
        print("4. üé® –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É—é JSON —Å—Ç—Ä—É–∫—Ç—É—Ä—É")
        print("5. üìê –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞—Ç—å –≥—Ä–∞—Ñ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º:")
        print("   ‚Ä¢ –î–µ–π—Å—Ç–≤–∏—è ‚Üí –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∏")
        print("   ‚Ä¢ –û–±—ä–µ–∫—Ç+—Å–æ—Å—Ç–æ—è–Ω–∏–µ ‚Üí –æ–≤–∞–ª—ã")
        print("   ‚Ä¢ –°—Ç—Ä–µ–ª–∫–∏ ‚Üí connection_in ‚Üí connection_out")
    else:
        print("‚ö†Ô∏è  –ï–°–¢–¨ –ü–†–û–ë–õ–ï–ú–´! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞.")
    
    print("\nüìÅ –°–û–ó–î–ê–ù–ù–´–ï –§–ê–ô–õ–´:")
    print("   ‚Ä¢ api-fixed-new-structure.py - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π API")
    print("   ‚Ä¢ sample_model_correct.json - –ø—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ JSON")
    print("   ‚Ä¢ IMPLEMENTATION_GUIDE.md - —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏")
    print("   ‚Ä¢ test_*.json - —Ç–µ—Å—Ç–æ–≤—ã–µ –ø—Ä–∏–º–µ—Ä—ã")
    
    sys.exit(0 if system_ok else 1)